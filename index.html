<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library System - Fully Working</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .star { cursor: pointer; font-size: 2.5rem; color: #fbbf24; }
    .star.filled { color: #f59e0b; }
    .code { font-family: monospace; font-size: 3rem; font-weight: bold; color: #1e40af; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

  <div class="container mx-auto p-8 max-w-7xl">
    <h1 class="text-6xl font-bold text-center my-12 text-indigo-800">Library Management System</h1>

    <!-- Add Book Form -->
    <div class="bg-white rounded-2xl shadow-2xl p-10 mb-10">
      <h2 class="text-4xl font-bold mb-8 text-indigo-700">Add New Book</h2>
      <form id="addBook" class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <input type="text" id="title" placeholder="Book Title" required class="p-5 border-2 rounded-xl text-xl">
        <input type="text" id="author" placeholder="Author Name" required class="p-5 border-2 rounded-xl text-xl">
        <input type="text" id="category" placeholder="Category" required class="p-5 border-2 rounded-xl text-xl">
        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-2xl rounded-xl transition">
          Add Book
        </button>
      </form>
    </div>

    <!-- Search + Book List -->
    <div class="bg-white rounded-2xl shadow-2xl p-10">
      <input type="text" id="search" placeholder="Search by title, author or code..." class="w-full p-5 border-2 rounded-xl text-xl mb-8">
      <div id="booksList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    </div>
  </div>

  <!-- Toast Message -->
  <div id="toast" class="fixed bottom-10 right-10 px-10 py-6 rounded-2xl text-white font-bold text-2xl shadow-2xl z-50 hidden"></div>

  <script>
    const supabase = supabase.createClient(
      'https://mzldtrcpufmeikohxxxz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16bGR0cmNwdWZtZWlrb2h4eHh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3Mzc1MjMsImV4cCI6MjA3OTMxMzUyM30.NEMg1yPF4eOuCqu-WbpYL1p91HDhoiOHKYo2yuH7LH4'
    );

    function toast(msg, error = false) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = error 
        ? 'fixed bottom-10 right-10 px-10 py-6 bg-red-600 text-white font-bold text-2xl rounded-2xl shadow-2xl z-50' 
        : 'fixed bottom-10 right-10 px-10 py-6 bg-green-600 text-white font-bold text-2xl rounded-2xl shadow-2xl z-50';
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 5000);
    }

    // Generate Unique 5-digit Code
    async function generateUniqueCode() {
      for (let i = 0; i < 100; i++) {
        const code = Math.floor(10000 + Math.random() * 90000);
        const { data } = await supabase.from('books').select('id').eq('code', code).maybeSingle();
        if (!data) return code;
      }
      throw new Error("Couldn't generate unique code");
    }

    // Add Book
    document.getElementById('addBook').onsubmit = async (e) => {
      e.preventDefault();
      const title = e.target.title.value.trim();
      const author = e.target.author.value.trim();
      const category = e.target.category.value.trim();

      try {
        const code = await generateUniqueCode();
        
        const { error } = await supabase.from('books').insert({
          code,
          title,
          author,
          category,
          status: 'Available'
        });

        if (error) throw error;

        toast(`Book Added Successfully! Code: ${code}`);
        e.target.reset();
        loadBooks(); // Refresh list immediately

      } catch (err) {
        toast("Error: " + err.message, true);
      }
    };

    // Load All Books
    async function loadBooks() {
      const search = document.getElementById('search').value.toLowerCase();
      
      const { data: books, error } = await supabase.from('books').select('*');
      
      if (error) {
        toast("Failed to load books", true);
        return;
      }

      const filtered = books.filter(book => 
        book.title.toLowerCase().includes(search) ||
        book.author.toLowerCase().includes(search) ||
        book.code.toString().includes(search)
      );

      document.getElementById('booksList').innerHTML = filtered.map(book => `
        <div class="border-4 ${book.status === 'Available' ? 'border-green-500' : 'border-red-500'} 
                     rounded-2xl p-8 bg-gradient-to-br from-white to-gray-50 shadow-xl hover:shadow-2xl transition">
          <h3 class="text-3xl font-bold text-gray-800 mb-3">${book.title}</h3>
          <p class="text-xl text-gray-600 mb-2"><strong>Author:</strong> ${book.author}</p>
          <p class="text-xl text-gray-600 mb-4"><strong>Category:</strong> ${book.category}</p>
          
          <div class="code mb-4">${book.code}</div>
          
          <p class="text-3xl font-bold ${book.status === 'Available' ? 'text-green-600' : 'text-red-600'}">
            ${book.status}
          </p>
        </div>
      `).join('') || '<p class="col-span-3 text-center text-3xl text-gray-500 mt-20">No books found</p>';
    }

    // Live Search
    document.getElementById('search').addEventListener('input', loadBooks);

    // Load books on page open
    loadBooks();

    // Optional: Refresh every 5 seconds (real-time feel)
    setInterval(loadBooks, 5000);
  </script>
</body>
</html>
