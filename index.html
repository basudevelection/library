<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library System - Working</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .star { cursor: pointer; font-size: 2.5rem; }
    .star.filled { color: #f59e0b; }
    .star { color: #fbbf24; }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 min-h-screen">

  <div class="container mx-auto p-6 max-w-7xl">
    <h1 class="text-6xl font-bold text-center my-10 text-indigo-800">Library System</h1>

    <!-- Tabs -->
    <div class="flex gap-4 mb-8 flex-wrap">
      <button onclick="tab('books')" class="tab active px-8 py-4 bg-white rounded-lg shadow font-bold">Books</button>
      <button onclick="tab('issue')" class="tab px-8 py-4 bg-white rounded-lg shadow font-bold">Issue</button>
      <button onclick="tab('return')" class="tab px-8 py-4 bg-white rounded-lg shadow font-bold">Return/Renew</button>
      <button onclick="tab('issued')" class="tab px-8 py-4 bg-white rounded-lg shadow font-bold">Issued</button>
      <button onclick="tab('history')" class="tab px-8 py-4 bg-white rounded-lg shadow font-bold">History</button>
    </div>

    <!-- Books Tab -->
    <div id="books" class="block">
      <div class="bg-white p-8 rounded-xl shadow-lg mb-8">
        <h2 class="text-3xl font-bold mb-6">Add New Book</h2>
        <form id="addBook" class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <input type="text" placeholder="Title" id="title" required class="p-4 border rounded-lg">
          <input type="text" placeholder="Author" id="author" required class="p-4 border rounded-lg">
          <input type="text" placeholder="Category" id="cat" required class="p-4 border rounded-lg">
          <button type="submit" class="bg-indigo-600 text-white p-4 rounded-lg font-bold">Add Book</button>
        </form>
      </div>

      <input type="text" id="search" placeholder="Search..." class="w-full p-4 border rounded-lg mb-6">
      <div id="bookList" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
    </div>

    <!-- Issue Tab -->
    <div id="issue" class="hidden">
      <div class="max-w-2xl mx-auto bg-white p-10 rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold mb-8 text-green-600">Issue Book</h2>
        <form id="issueForm" class="space-y-6">
          <input type="number" id="issueCode" placeholder="Book Code" required class="w-full p-5 border-2 rounded-lg text-xl">
          <input type="text" id="sname" placeholder="Student Name" required class="w-full p-5 border-2 rounded-lg text-xl">
          <input type="text" id="sroll" placeholder="Roll No" required class="w-full p-5 border-2 rounded-lg text-xl">
          <button type="submit" class="w-full bg-green-600 text-white py-6 rounded-lg text-2xl font-bold">Issue Now</button>
        </form>
      </div>
    </div>

    <!-- Return Tab -->
    <div id="return" class="hidden">
      <div class="max-w-4xl mx-auto bg-white p-10 rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold mb-8 text-red-600">Return / Renew</h2>
        <input type="number" id="returnCode" placeholder="Enter Book Code" class="w-full p-6 border-2 rounded-lg text-2xl mb-8">
        <div id="returnInfo"></div>
      </div>
    </div>

    <!-- Issued & History -->
    <div id="issued" class="hidden bg-white rounded-xl shadow-lg overflow-hidden">
      <h2 class="text-3xl font-bold p-8 bg-indigo-600 text-white">Issued Books</h2>
      <table class="w-full"><tbody id="issuedList"></tbody></table>
    </div>

    <div id="history" class="hidden bg-white rounded-xl shadow-lg overflow-hidden">
      <h2 class="text-3xl font-bold p-8 bg-purple-600 text-white">History</h2>
      <table class="w-full"><tbody id="historyList"></tbody></table>
    </div>
  </div>

  <!-- Rating Modal -->
  <div id="ratingModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
    <div class="bg-white p-10 rounded-xl shadow-2xl text-center max-w-md w-full">
      <h2 class="text-3xl font-bold mb-4">Rate "<span id="rateTitle"></span>"</h2>
      <div class="flex justify-center gap-2 my-8">
        <span class="star" onclick="rate(1)">Star</span>
        <span class="star" onclick="rate(2)">Star</span>
        <span class="star" onclick="rate(3)">Star</span>
        <span class="star" onclick="rate(4)">Star</span>
        <span class="star" onclick="rate(5)">Star</span>
      </div>
      <p>Selected: <strong id="stars">0</strong>/5</p>
      <textarea id="review" placeholder="Optional review..." class="w-full p-4 border rounded-lg mt-4" rows="3"></textarea>
      <div class="flex gap-4 mt-6">
        <button onclick="submitRate()" class="flex-1 bg-green-600 text-white py-4 rounded-lg font-bold">Submit</button>
        <button onclick="document.getElementById('ratingModal').classList.add('hidden')" class="flex-1 bg-gray-500 text-white py-4 rounded-lg font-bold">Skip</button>
      </div>
    </div>
  </div>

  <div id="msg" class="fixed bottom-8 right-8 bg-green-600 text-white px-8 py-5 rounded-xl shadow-2xl text-xl font-bold hidden"></div>

  <script>
    const supabase = supabase.createClient(
      'https://mzldtrcpufmeikohxxxz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16bGR0cmNwdWZtZWlrb2h4eHh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3Mzc1MjMsImV4cCI6MjA3OTMxMzUyM30.NEMg1yPF4eOuCqu-WbpYL1p91HDhoiOHKYo2yuH7LH4'
    );

    let currentTransId = null, currentBookCode = null, currentTitle = '', currentRoll = '', rating = 0;

    function msg(text, error = false) {
      const m = document.getElementById('msg');
      m.textContent = text;
      m.className = error ? 'fixed bottom-8 right-8 bg-red-600 text-white px-8 py-5 rounded-xl shadow-2xl text-xl font-bold' : 'fixed bottom-8 right-8 bg-green-600 text-white px-8 py-5 rounded-xl shadow-2xl text-xl font-bold';
      m.classList.remove('hidden');
      setTimeout(() => m.classList.add('hidden'), 4000);
    }

    function tab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('button.tab').forEach(b => b.classList.remove('bg-indigo-600', 'text-white'));
      document.querySelector(`button[onclick="tab('${id}')"]`).classList.add('bg-indigo-600', 'text-white');
      document.querySelectorAll('#books, #issue, #return, #issued, #history').forEach(d => d.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if (id === 'books') loadBooks();
      if (id === 'issued') loadIssued();
      if (id === 'history') loadHistory();
    }

    // Generate unique 5-digit code
    async function newCode() {
      for (let i = 0; i < 100; i++) {
        const code = Math.floor(10000 + Math.random() * 90000);
        const { data } = await supabase.from('books').select('id').eq('code', code).maybeSingle();
        if (!data) return code;
      }
      throw "Can't generate code";
    }

    // Add Book
    document.getElementById('addBook').onsubmit = async e => {
      e.preventDefault();
      const code = await newCode();
      const { error } = await supabase.from('books').insert({
        code,
        title: e.target.title.value,
        author: e.target.author.value,
        category: e.target.cat.value,
        status: 'Available'
      });
      if (error) return msg(error.message, true);
      msg(`Book added! Code: ${code}`);
      e.target.reset();
      loadBooks();
    };

    // Load Books + Rating
    async function loadBooks() {
      const { data: books } = await supabase.from('books').select('*');
      const { data: rates } = await supabase.from('ratings').select('book_code,rating');
      const avg = {};
      rates?.forEach(r => {
        if (!avg[r.book_code]) avg[r.book_code] = {s:0,c:0};
        avg[r.book_code].s += r.rating;
        avg[r.book_code].c++;
      });

      const s = document.getElementById('search').value.toLowerCase();
      const list = document.getElementById('bookList');
      list.innerHTML = books
        .filter(b => b.title.toLowerCase().includes(s) || b.author.toLowerCase().includes(s) || b.code.toString().includes(s))
        .map(b => {
          const r = avg[b.code];
          const av = r ? (r.s / r.c).toFixed(1) : 'N/A';
          return `<div class="border-4 ${b.status==='Available'?'border-green-500':'border-red-500'} rounded-xl p-6 bg-white shadow-lg">
            <h3 class="text-2xl font-bold">${b.title}</h3>
            <p><strong>Author:</strong> ${b.author}</p>
            <p><strong>Category:</strong> ${b.category}</p>
            <p class="text-3xl font-mono font-bold mt-4">CODE: ${b.code}</p>
            <p class="text-3xl font-bold ${b.status==='Available'?'text-green-600':'text-red-600'}">${b.status}</p>
            <p class="text-xl mt-4"><strong>Rating:</strong> ${av}/5 (${r?.c||0} reviews)</p>
          </div>`;
        }).join('') || '<p class="text-center text-gray-500 text-2xl col-span-3">No books</p>';
    }

    document.getElementById('search').oninput = loadBooks;

    // Issue Book
    document.getElementById('issueForm').onsubmit = async e => {
      e.preventDefault();
      const code = +e.target.issueCode.value;
      const { data: book } = await supabase.from('books').select('*').eq('code', code).single();
      if (!book || book.status !== 'Available') return msg('Book not available', true);

      const due = new Date(Date.now() + 15*24*60*60*1000).toISOString();
      await supabase.from('transactions').insert({
        book_code: code,
        book_title: book.title,
        student_name: e.target.sname.value,
        roll_no: e.target.sroll.value,
        issue_date: new Date().toISOString(),
        due_date: due,
        status: 'Issued'
      });
      await supabase.from('books').update({status:'Issued'}).eq('code', code);
      msg('Issued successfully!');
      e.target.reset();
      loadIssued();
    };

    // Return Lookup
    document.getElementById('returnCode').oninput = async function() {
      const code = +this.value;
      if (!code) { document.getElementById('returnInfo').innerHTML = ''; return; }
      const { data: t } = await supabase.from('transactions').select('*').eq('book_code', code).in('status',['Issued','Renewed']).single();
      if (!t) { document.getElementById('returnInfo').innerHTML = '<p class="text-red-600 text-3xl">Not issued</p>'; return; }

      const late = Math.max(0, Math.floor((Date.now() - new Date(t.due_date)) / 86400000));
      const fine = late * 2;
      currentTransId = t.id;
      currentBookCode = code;
      currentTitle = t.book_title;
      currentRoll = t.roll_no;

      document.getElementById('returnInfo').innerHTML = `
        <div class="bg-gray-100 p-8 rounded-xl mt-8 border-4 border-dashed">
          <h3 class="text-4xl font-bold">${t.book_title}</h3>
          <p class="text-2xl mt-4">Student: ${t.student_name} (${t.roll_no})</p>
          <p class="text-3xl font-bold text-red-600 mt-6">Late: ${late} days → Fine: ₹${fine}</p>
          <div class="mt-8 flex gap-8">
            <button onclick="doReturn(${code},${fine},${t.id})" class="bg-red-600 text-white px-12 py-6 rounded-xl text-3xl font-bold">Return Now</button>
            <button onclick="doRenew(${code})" class="bg-blue-600 text-white px-12 py-6 rounded-xl text-3xl font-bold">Renew +15 days</button>
          </div>
        </div>`;
    };

    window.doReturn = async (code, fine, transId) => {
      await supabase.from('transactions').update({return_date: new Date().toISOString(), fine, status:'Returned'}).eq('id', transId);
      await supabase.from('books').update({status:'Available'}).eq('code', code);
      msg('Returned! Fine: ₹' + fine);
      document.getElementById('returnCode').value = '';
      document.getElementById('returnInfo').innerHTML = '';
      document.getElementById('rateTitle').textContent = currentTitle;
      document.getElementById('ratingModal').classList.remove('hidden');
      loadIssued(); loadHistory(); loadBooks();
    };

    window.doRenew = async code => {
      const { data: t } = await supabase.from('transactions').select('*').eq('book_code', code).single();
      const d = new Date(t.due_date);
      d.setDate(d.getDate() + 15);
      await supabase.from('transactions').update({due_date: d.toISOString(), status:'Renewed'}).eq('id', t.id);
      msg('Renewed!');
      loadIssued();
    };

    // Rating
    function rate(n) {
      rating = n;
      document.getElementById('stars').textContent = n;
      document.querySelectorAll('.star').forEach((s,i) => s.classList.toggle('filled', i < n));
    }
    window.submitRate = async () => {
      if (rating === 0) return msg('Select stars', true);
      const { error } = await supabase.from('ratings').insert({
        transaction_id: currentTransId,
        book_code: currentBookCode,
        roll_no: currentRoll,
        rating,
        review: document.getElementById('review').value
      });
      if (error) return msg(error.message, true);
      msg('Thank you for rating!');
      document.getElementById('ratingModal').classList.add('hidden');
      rating = 0;
      document.getElementById('review').value = '';
      loadBooks();
    };

    // Load Issued & History
    async function loadIssued() {
      const { data } = await supabase.from('transactions').select('*').in('status',['Issued','Renewed']);
      document.getElementById('issuedList').innerHTML = data.map(t => {
        const late = Math.max(0, Math.floor((Date.now() - new Date(t.due_date)) / 86400000));
        return `<tr class="${late>0?'bg-red-100':''}"><td class="p-6 font-mono text-xl">${t.book_code}</td><td class="p-6 font-bold text-xl">${t.book_title}</td><td class="p-6">${t.student_name}<br><small>${t.roll_no}</small></td><td class="p-6">${new Date(t.due_date).toLocaleDateString()}</td><td class="p-6 text-red-600 font-bold">₹${late*2}</td></tr>`;
      }).join('') || '<tr><td class="text-center py-10 text-gray-500" colspan="5">No books issued</td></tr>';
    }

    async function loadHistory() {
      const { data } = await supabase.from('transactions').select('*, ratings(rating)').eq('status','Returned');
      document.getElementById('historyList').innerHTML = data.map(t => `
        <tr>
          <td class="p-6 font-mono">${t.book_code}</td>
          <td class="p-6">${t.student_name} (${t.roll_no})</td>
          <td class="p-6">${new Date(t.issue_date).toLocaleDateString()}</td>
          <td class="p-6">${new Date(t.return_date).toLocaleDateString()}</td>
          <td class="p-6 font-bold">₹${t.fine||0}</td>
          <td class="p-6">${t.ratings?.rating ? t.ratings.rating+'/5 Stars'.repeat(t.ratings.rating) : 'No rating'}</td>
        </tr>`).join('') || '<tr><td colspan="6" class="text-center py-10 text-gray-500">No history</td></tr>';
    }

    // Start
    loadBooks();
  </script>
</body>
</html>
