<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Library Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .tab-btn.active { @apply border-b-4 border-indigo-600 text-indigo-600 font-bold; }
    .hidden { display: none; }
    #toast { transition: all 0.3s; }
    .star { cursor: pointer; font-size: 2rem; color: #fbbf24; }
    .star.filled { color: #f59e0b; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
      <h2 class="text-3xl font-bold mb-6 text-center">Library Login</h2>
      <form id="authForm" class="space-y-5">
        <input type="email" id="email" value="test@example.com" placeholder="Email" required class="w-full p-4 border-2 rounded-lg text-lg"/>
        <input type="password" id="password" value="123456" placeholder="Password" required class="w-full p-4 border-2 rounded-lg text-lg"/>
        <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-lg text-xl font-bold hover:bg-indigo-700">
          Login / Register
        </button>
      </form>
      <p class="text-center mt-4 text-sm text-gray-600">First time? It auto-registers.</p>
    </div>
  </div>

  <!-- Rating Modal -->
  <div id="ratingModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-10 rounded-xl shadow-2xl max-w-lg w-full mx-4 text-center">
      <h2 class="text-3xl font-bold mb-4">Rate This Book</h2>
      <p id="bookTitleForRating" class="text-xl mb-6 text-gray-700"></p>
      <div class="flex justify-center gap-3 mb-6">
        <span class="star" onclick="setRating(1)">Star</span>
        <span class="star" onclick="setRating(2)">Star</span>
        <span class="star" onclick="setRating(3)">Star</span>
        <span class="star" onclick="setRating(4)">Star</span>
        <span class="star" onclick="setRating(5)">Star</span>
      </div>
      <p class="text-lg mb-4">Your rating: <span id="selectedRating" class="font-bold">0</span>/5</p>
      <textarea id="reviewText" placeholder="Optional review..." class="w-full p-4 border-2 rounded-lg mb-6" rows="3"></textarea>
      <div class="flex gap-4">
        <button onclick="submitRating()" class="flex-1 bg-green-600 text-white py-4 rounded-lg text-xl font-bold hover:bg-green-700">Submit Rating</button>
        <button onclick="closeRating()" class="flex-1 bg-gray-500 text-white py-4 rounded-lg text-xl font-bold hover:bg-gray-600">Skip</button>
      </div>
    </div>
  </div>

  <div class="container mx-auto p-6 max-w-7xl">
    <h1 class="text-5xl font-bold text-center my-10 text-indigo-800">Library Management System</h1>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-3 mb-10 bg-white rounded-lg shadow p-3 overflow-x-auto">
      <button onclick="showTab('books')" class="tab-btn active px-8 py-4 rounded-lg text-lg">Books</button>
      <button onclick="showTab('issue')" class="tab-btn px-8 py-4 rounded-lg text-lg">Issue Book</button>
      <button onclick="showTab('return')" class="tab-btn px-8 py-4 rounded-lg text-lg">Return / Renew</button>
      <button onclick="showTab('issued')" class="tab-btn px-8 py-4 rounded-lg text-lg">Issued Books</button>
      <button onclick="showTab('history')" class="tab-btn px-8 py-4 rounded-lg text-lg">History</button>
    </div>

    <!-- Books Tab -->
    <div id="books" class="tab-content">
      <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <h2 class="text-3xl font-bold mb-6 text-indigo-700">Add New Book</h2>
        <form id="bookForm" class="grid md:grid-cols-4 gap-4">
          <input type="text" id="title" placeholder="Title" required class="p-4 border-2 rounded-lg"/>
          <input type="text" id="author" placeholder="Author" required class="p-4 border-2 rounded-lg"/>
          <input type="text" id="category" placeholder="Category" required class="p-4 border-2 rounded-lg"/>
          <button type="submit" class="bg-indigo-600 text-white py-4 rounded-lg font-bold text-xl hover:bg-indigo-700">Add Book</button>
        </form>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-8">
        <input type="text" id="searchInput" placeholder="Search books..." class="w-full p-4 border-2 rounded-lg mb-6 text-lg"/>
        <div id="booksList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
      </div>
    </div>

    <!-- Issue, Return, Issued, History tabs (same as before - simplified for brevity) -->
    <div id="issue" class="tab-content hidden">
      <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-10">
        <h2 class="text-3xl font-bold mb-8 text-green-700">Issue Book</h2>
        <form id="issueForm" class="space-y-6">
          <input type="number" id="issueCode" placeholder="Book Code (5 digits)" required class="w-full p-5 border-2 rounded-lg text-xl"/>
          <input type="text" id="studentName" placeholder="Student Name" required class="w-full p-5 border-2 rounded-lg text-xl"/>
          <input type="text" id="rollNo" placeholder="Roll No" required class="w-full p-5 border-2 rounded-lg text-xl"/>
          <button type="submit" class="w-full bg-green-600 text-white py-6 rounded-lg text-2xl font-bold">Issue Book</button>
        </form>
      </div>
    </div>

    <div id="return" class="tab-content hidden">
      <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-10">
        <h2 class="text-3xl font-bold mb-8 text-red-700">Return / Renew Book</h2>
        <input type="number" id="returnCode" placeholder="Enter Book Code" class="w-full p-6 border-2 rounded-lg text-2xl mb-8"/>
        <div id="returnDetails"></div>
      </div>
    </div>

    <div id="issued" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <h2 class="text-3xl font-bold p-8 bg-indigo-600 text-white">Currently Issued</h2>
        <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-100"><tr>
          <th class="px-6 py-4 text-left">Code</th><th class="px-6 py-4 text-left">Title</th>
          <th class="px-6 py-4 text-left">Student</th><th class="px-6 py-4 text-left">Due</th>
          <th class="px-6 py-4 text-left">Fine ₹</th>
        </tr></thead><tbody id="issuedTable"></tbody></table></div>
      </div>
    </div>

    <div id="history" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <h2 class="text-3xl font-bold p-8 bg-purple-600 text-white">History</h2>
        <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-100"><tr>
          <th class="px-6 py-4 text-left">Code</th><th class="px-6 py-4 text-left">Student</th>
          <th class="px-6 py-4 text-left">Issued</th><th class="px-6 py-4 text-left">Returned</th>
          <th class="px-6 py-4 text-left">Fine ₹</th><th class="px-6 py-4 text-left">Rating</th>
        </tr></thead><tbody id="historyTable"></tbody></table></div>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-8 right-8 px-8 py-5 rounded-xl text-white font-bold text-lg shadow-2xl z-50 hidden"></div>

  <script>
    const supabase = supabase.createClient(
      'https://mzldtrcpufmeikohxxxz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16bGR0cmNwdWZtZWlrb2h4eHh6Iiwicm9sZSI6ImFub24sImlhdCI6MTc2MzczNzUyMywiZXhwIjoyMDc5MzEzNTIzfQ.NEMg1yPF4eOuCqu-WbpYL1p91HDhoiOHKYo2yuH7LH4'
    );

    let user = null;
    let currentTransId = null;
    let currentBookTitle = '';
    let currentRollNo = '';
    let selectedStars = 0;

    // Auth
    document.getElementById('authForm').onsubmit = async e => {
      e.preventDefault();
      const { data, error } = await supabase.auth.signInWithPassword({
        email: e.target.email.value,
        password: e.target.password.value
      });
      if (error) await supabase.auth.signUp({ email: e.target.email.value, password: e.target.password.value });
      else user = data.user;
      document.getElementById('loginModal').classList.add('hidden');
      loadAll();
    };

    supabase.auth.getSession().then(({ data }) => {
      if (data.session) { user = data.session.user; document.getElementById('loginModal').classList.add('hidden'); loadAll(); }
    });

    function toast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `fixed bottom-8 right-8 px-8 py-5 rounded-xl text-white font-bold text-lg shadow-2xl z-50 ${type==='error'?'bg-red-600':type==='warn'?'bg-yellow-600':'bg-green-600'}`;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 4000);
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'font-bold'));
      document.getElementById(tab).classList.remove('hidden');
      event.target.classList.add('active');
      loadAll();
    }

    // Generate unique 5-digit code
    async function generateCode() {
      for (let i = 0; i < 50; i++) {
        const code = Math.floor(10000 + Math.random() * 90000);
        const { data } = await supabase.from('books').select('id').eq('code', code).maybeSingle();
        if (!data) return code;
      }
      throw new Error('Cannot generate unique code');
    }

    // Add Book
    document.getElementById('bookForm').onsubmit = async e => {
      e.preventDefault();
      if (!user) return toast('Login required', 'error');
      const code = await generateCode();
      const { error } = await supabase.from('books').insert({
        code,
        title: e.target.title.value,
        author: e.target.author.value,
        category: e.target.category.value,
        created_by: user.id
      });
      if (error) return toast(error.message, 'error');
      toast(`Book added! Code: ${code}`);
      e.target.reset();
      loadBooks();
    };

    // Load Books with Ratings
    async function loadBooks() {
      const { data: books } = await supabase.from('books').select('*');
      const { data: ratings } = await supabase.from('ratings').select('book_code, rating');
      const ratingMap = {};
      ratings?.forEach(r => {
        if (!ratingMap[r.book_code]) ratingMap[r.book_code] = { sum: 0, count: 0 };
        ratingMap[r.book_code].sum += r.rating;
        ratingMap[r.book_code].count += 1;
      });

      const search = document.getElementById('searchInput').value.toLowerCase();
      const filtered = books.filter(b =>
        b.title.toLowerCase().includes(search) ||
        b.author.toLowerCase().includes(search) ||
        b.code.toString().includes(search)
      );

      document.getElementById('booksList').innerHTML = filtered.map(b => {
        const r = ratingMap[b.code];
        const avg = r ? (r.sum / r.count).toFixed(1) : 'N/A';
        const stars = r ? '★'.repeat(Math.round(avg)) + '☆'.repeat(5-Math.round(avg)) : '';
        return `
          <div class="border-2 rounded-xl p-6 hover:shadow-2xl transition ${b.status==='Available'?'border-green-400':'border-red-400'}">
            <h3 class="text-2xl font-bold">${b.title}</h3>
            <p class="text-lg"><strong>Author:</strong> ${b.author}</p>
            <p><strong>Category:</strong> ${b.category}</p>
            <p class="font-mono text-2xl font-bold mt-4">Code: ${b.code}</p>
            <p class="text-3xl font-bold mt-4 ${b.status==='Available'?'text-green-600':'text-red-600'}">${b.status}</p>
            <p class="text-xl mt-4"><strong>Rating:</strong> ${avg}/5 ${stars} (${r?.count||0} reviews)</p>
          </div>
        `;
      }).join('') || '<p class="text-center text-gray-500 col-span-3">No books found</p>';
    }

    document.getElementById('searchInput').oninput = loadBooks;

    // Issue Book
    document.getElementById('issueForm').onsubmit = async e => {
      e.preventDefault();
      const code = +e.target.issueCode.value;
      const { data: book } = await supabase.from('books').select('*').eq('code', code).single();
      if (!book || book.status === 'Issued') return toast('Book not available', 'error');

      const issueDate = new Date().toISOString();
      const dueDate = new Date(Date.now() + 15*24*60*60*1000).toISOString();

      await supabase.from('transactions').insert({
        book_code: code,
        book_title: book.title,
        student_name: e.target.studentName.value,
        roll_no: e.target.rollNo.value,
        issue_date: issueDate,
        due_date: dueDate,
        created_by: user.id
      });
      await supabase.from('books').update({ status: 'Issued' }).eq('code', code);
      toast('Book issued successfully!');
      e.target.reset();
();
      loadIssued();
    };

    // Return Lookup
    document.getElementById('returnCode').oninput = async function() {
      const code = +this.value;
      if (!code) { document.getElementById('returnDetails').innerHTML = ''; return; }
      const { data: trans } = await supabase.from('transactions').select('*').eq('book_code', code).eq('status', 'Issued').single();
      if (!trans) {
        document.getElementById('returnDetails').innerHTML = '<p class="text-red-600 text-2xl">Not issued</p>';
        return;
      }
      const daysLate = Math.max(0, Math.floor((Date.now() - new Date(trans.due_date)) / 86400000));
      const fine = daysLate * 2;
      currentTransId = trans.id;
      currentBookTitle = trans.book_title;
      currentRollNo = trans.roll_no;

      document.getElementById('returnDetails').innerHTML = `
        <div class="bg-gray-50 p-8 rounded-xl border-4 border-dashed mt-8">
          <h3 class="text-3xl font-bold">${trans.book_title}</h3>
          <p class="text-xl">Student: ${trans.student_name} (${trans.roll_no})</p>
          <p class="text-2xl font-bold text-red-600 mt-4">Late: ${daysLate} days → Fine: ₹${fine}</p>
          <div class="mt-8 flex gap-6">
            <button onclick="returnBook(${code}, ${fine}, ${trans.id})" class="bg-red-600 text-white px-12 py-5 rounded-xl text-2xl font-bold">Return Now</button>
            <button onclick="renewBook(${code})" class="bg-blue-600 text-white px-12 py-5 rounded-xl text-2xl font-bold">Renew (+15 days)</button>
          </div>
        </div>
      `;
    };

    window.returnBook = async (code, fine, transId) => {
      await supabase.from('transactions').update({ return_date: new Date().toISOString(), fine, status: 'Returned' }).eq('id', transId);
      await supabase.from('books').update({ status: 'Available' }).eq('code', code);
      toast('Book returned! Fine: ₹' + fine);
      document.getElementById('returnCode').value = '';
      document.getElementById('returnDetails').innerHTML = '';
      document.getElementById('bookTitleForRating').textContent = currentBookTitle;
      document.getElementById('ratingModal').classList.remove('hidden');
      loadIssued(); loadHistory(); loadBooks();
    };

    window.renewBook = async code => {
      const { data: trans } = await supabase.from('transactions').select('*').eq('book_code', code).single();
      const newDue = new Date(trans.due_date);
      newDue.setDate(newDue.getDate() + 15);
      await supabase.from('transactions').update({ due_date: newDue.toISOString(), status: 'Renewed' }).eq('id', trans.id);
      toast('Renewed! New due: ' + newDue.toLocaleDateString());
      loadIssued();
    };

    // Rating
    function setRating(n) {
      selectedStars = n;
      document.getElementById('selectedRating').textContent = n;
      document.querySelectorAll('.star').forEach((s,i) => s.classList.toggle('filled', i < n));
    }
    function closeRating() { document.getElementById('ratingModal').classList.add('hidden'); selectedStars = 0; }
    window.submitRating = async () => {
      if (selectedStars === 0) return toast('Select stars', 'warn');
      const { error } = await supabase.from('ratings').insert({
        transaction_id: currentTransId,
        book_code: +document.getElementById('returnCode').value || 0,
        roll_no: currentRollNo,
        rating: selectedStars,
        review: document.getElementById('reviewText').value
      });
      if (error) return toast(error.message, 'error');
      toast('Thank you for rating!');
      closeRating();
      loadBooks(); loadHistory();
    };

    // Load Issued & History (simplified but working)
    async function loadIssued() {
      const { data } = await supabase.from('transactions').select('*').in('status', ['Issued', 'Renewed']);
      const tbody = document.getElementById('issuedTable');
      tbody.innerHTML = data.map(t => {
        const late = Math.max(0, Math.floor((Date.now() - new Date(t.due_date)) / 86400000));
        return `<tr class="${late>0?'bg-red-100':''}">
          <td class="px-6 py-4 font-mono">${t.book_code}</td>
          <td class="px-6 py-4 font-bold">${t.book_title}</td>
          <td class="px-6 py-4">${t.student_name}<br><small>${t.roll_no}</small></td>
          <td class="px-6 py-4">${new Date(t.due_date).toLocaleDateString()}</td>
          <td class="px-6 py-4 font-bold text-red-600">₹${late*2}</td>
        </tr>`;
      }).join('') || '<tr><td colspan="5" class="text-center py-10 text-gray-500">No books issued</td></tr>';
    }

    async function loadHistory() {
      const { data } = await supabase.from('transactions').select('*, ratings(rating)').eq('status', 'Returned');
      document.getElementById('historyTable').innerHTML = data.map(t => `
        <tr>
          <td class="px-6 py-4 font-mono">${t.book_code}</td>
          <td class="px-6 py-4">${t.student_name}<br><small>${t.roll_no}</small></td>
          <td class="px-6 py-4">${new Date(t.issue_date).toLocaleDateString()}</td>
          <td class="px-6 py-4">${t.return_date ? new Date(t.return_date).toLocaleDateString() : '-'}</td>
          <td class="px-6 py-4 font-bold">₹${t.fine}</td>
          <td class="px-6 py-4">${t.ratings?.rating ? t.ratings.rating + '/5 ★'.repeat(t.ratings.rating) : 'No rating'}</td>
        </tr>
      `).join('') || '<tr><td colspan="6" class="text-center py-10 text-gray-500">No history</td></tr>';
    }

    function loadAll() {
      if (!user) return;
      const tab = document.querySelector('.tab-btn.active').onclick.toString().match(/'(\w+)'/)[1];
      if (tab === 'books') loadBooks();
      if (tab === 'issued') loadIssued();
      if (tab === 'history') loadHistory();
    }

    // Auto-load on tab change
    document.querySelectorAll('.tab-btn').forEach(btn => btn.onclick = () => setTimeout(loadAll, 100));
  </script>
</body>
</html>
