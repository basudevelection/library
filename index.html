<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Library Management System (Supabase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .tab-btn.active { @apply border-b-4 border-indigo-600 text-indigo-600 font-bold; }
    .hidden { display: none; }
    #toast { transition: all 0.3s; }
    #loginModal, #ratingModal { backdrop-filter: blur(5px); }
    .star { cursor: pointer; color: #fbbf24; }
    .star.filled { color: #f59e0b; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold mb-4">Login / Register</h2>
      <form id="authForm" class="space-y-4">
        <input type="email" id="email" placeholder="Email" required class="w-full p-3 border rounded-lg" />
        <input type="password" id="password" placeholder="Password" required class="w-full p-3 border rounded-lg" />
        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg">Login</button>
      </form>
      <p class="text-center mt-4 text-sm text-gray-600">No account? It will auto-register on first login.</p>
      <button onclick="closeLogin()" class="mt-4 text-gray-500">Skip (Demo Mode - Limited)</button>
    </div>
  </div>

  <!-- Rating Modal -->
  <div id="ratingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold mb-4">Rate This Book</h2>
      <p id="bookTitleForRating" class="mb-4 text-gray-600"></p>
      <div class="flex justify-center mb-4">
        <span class="star" onclick="setRating(1)">★</span>
        <span class="star" onclick="setRating(2)">★</span>
        <span class="star" onclick="setRating(3)">★</span>
        <span class="star" onclick="setRating(4)">★</span>
        <span class="star" onclick="setRating(5)">★</span>
      </div>
      <p class="text-sm text-gray-500 mb-4">Selected: <span id="selectedRating">0</span>/5</p>
      <textarea id="reviewText" placeholder="Optional review..." class="w-full p-3 border rounded-lg mb-4" rows="3"></textarea>
      <div class="flex gap-4">
        <button onclick="submitRating()" class="flex-1 bg-green-600 text-white py-2 rounded-lg">Submit</button>
        <button onclick="closeRating()" class="flex-1 bg-gray-500 text-white py-2 rounded-lg">Skip</button>
      </div>
    </div>
  </div>

  <div class="container mx-auto p-4 max-w-7xl">
    <h1 class="text-5xl font-bold text-center my-8 text-indigo-800 drop-shadow-lg">
      Library Management System
    </h1>
    <p class="text-center text-gray-600 mb-8">Powered by Supabase • Real-time Sync • Ratings & Reviews</p>

    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-8 bg-white rounded-lg shadow p-2 overflow-x-auto">
      <button onclick="showTab('books')" class="tab-btn active px-6 py-3 rounded-lg transition">Books</button>
      <button onclick="showTab('issue')" class="tab-btn px-6 py-3 rounded-lg transition">Issue Book</button>
      <button onclick="showTab('return')" class="tab-btn px-6 py-3 rounded-lg transition">Return / Renew</button>
      <button onclick="showTab('issued')" class="tab-btn px-6 py-3 rounded-lg transition">Issued Books</button>
      <button onclick="showTab('history')" class="tab-btn px-6 py-3 rounded-lg transition">History</button>
    </div>

    <!-- Books Section -->
    <div id="books" class="tab-content">
      <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <h2 class="text-3xl font-bold mb-6 text-indigo-700">Add New Book</h2>
        <form id="bookForm" class="grid md:grid-cols-3 gap-4 mb-8">
          <input type="text" id="title" placeholder="Book Title" required class="p-4 border-2 rounded-lg focus:border-indigo-500"/>
          <input type="text" id="author" placeholder="Author Name" required class="p-4 border-2 rounded-lg"/>
          <input type="text" id="category" placeholder="Category" required class="p-4 border-2 rounded-lg"/>
          <button type="submit" class="bg-indigo-600 text-white py-4 rounded-lg hover:bg-indigo-700 text-lg font-semibold">
            Add Book
          </button>
        </form>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-8">
        <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
          <input type="text" id="searchInput" placeholder="Search by Title, Author or Code..." class="p-4 border-2 rounded-lg w-full md:w-96"/>
          <select id="sortSelect" class="p-4 border-2 rounded-lg">
            <option value="title">Sort by Title</option>
            <option value="author">Sort by Author</option>
            <option value="status">Sort by Status</option>
          </select>
        </div>
        <div id="booksList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>
    </div>

    <!-- Issue Book -->
    <div id="issue" class="tab-content hidden">
      <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-10">
        <h2 class="text-3xl font-bold mb-8 text-green-700">Issue Book to Student</h2>
        <form id="issueForm" class="space-y-6">
          <input type="number" id="issueCode" placeholder="Enter 5-digit Book Code (e.g. 12345)" min="10000" max="99999" required class="w-full p-4 border-2 rounded-lg text-lg"/>
          <input type="text" id="studentName" placeholder="Student Full Name" required class="w-full p-4 border-2 rounded-lg text-lg"/>
          <input type="text" id="rollNo" placeholder="Roll Number / ID" required class="w-full p-4 border-2 rounded-lg text-lg"/>
          <button type="submit" class="w-full bg-green-600 text-white py-5 rounded-lg text-xl font-bold hover:bg-green-700">
            Issue Book Now
          </button>
        </form>
      </div>
    </div>

    <!-- Return / Renew -->
    <div id="return" class="tab-content hidden">
      <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-10">
        <h2 class="text-3xl font-bold mb-8 text-red-700">Return or Renew Book</h2>
        <input type="number" id="returnCode" placeholder="Enter 5-digit Book Code" min="10000" max="99999" class="w-full p-5 border-2 rounded-lg text-xl mb-8"/>
        <div id="returnDetails"></div>
      </div>
    </div>

    <!-- Issued Books -->
    <div id="issued" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <h2 class="text-3xl font-bold p-8 bg-indigo-600 text-white">Currently Issued Books</h2>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-4 text-left">Code</th>
                <th class="px-6 py-4 text-left">Book Title</th>
                <th class="px-6 py-4 text-left">Student</th>
                <th class="px-6 py-4 text-left">Issue Date</th>
                <th class="px-6 py-4 text-left">Due Date</th>
                <th class="px-6 py-4 text-left">Late Days</th>
                <th class="px-6 py-4 text-left">Fine ₹</th>
              </tr>
            </thead>
            <tbody id="issuedTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- History -->
    <div id="history" class="tab-content hidden">
      <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <h2 class="text-3xl font-bold p-8 bg-purple-600 text-white">Transaction History</h2>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-6 py-4 text-left">Code</th>
                <th class="px-6 py-4 text-left">Student</th>
                <th class="px-6 py-4 text-left">Issued</th>
                <th class="px-6 py-4 text-left">Returned</th>
                <th class="px-6 py-4 text-left">Fine ₹</th>
                <th class="px-6 py-4 text-left">Rating</th>
                <th class="px-6 py-4 text-left">Status</th>
              </tr>
            </thead>
            <tbody id="historyTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-8 right-8 px-8 py-5 rounded-xl text-white font-bold text-lg shadow-2xl z-50 hidden"></div>

  <script>
    // ============ Supabase Setup ============
    const supabaseUrl = 'https://mzldtrcpufmeikohxxxz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16bGR0cmNwdWZtZWlrb2h4eHh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3Mzc1MjMsImV4cCI6MjA3OTMxMzUyM30.NEMg1yPF4eOuCqu-WbpYL1p91HDhoiOHKYo2yuH7LH4';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let currentTransactionId = null;
    let currentBookTitle = '';
    let selectedStars = 0;

    // Auth (unchanged)
    async function signIn(email, password) {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return toast(error.message, 'error');
      currentUser = data.user;
      closeLogin();
      loadAll();
    }

    document.getElementById('authForm').onsubmit = (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      signIn(email, password);
    };

    function closeLogin() {
      document.getElementById('loginModal').classList.add('hidden');
      if (!currentUser) toast('Demo mode: Limited to view only', 'warn');
    }

    supabase.auth.getSession().then(({ data: { session } }) => {
      currentUser = session?.user ?? null;
      if (!currentUser) {
        document.getElementById('loginModal').classList.remove('hidden');
      } else {
        loadAll();
      }
    });

    supabase.auth.onAuthStateChange((event, session) => {
      currentUser = session?.user ?? null;
      if (event === 'SIGNED_IN') loadAll();
    });

    // ============ Helpers ============
    function toast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `fixed bottom-8 right-8 px-8 py-5 rounded-xl text-white font-bold text-lg shadow-2xl z-50 
        ${type === 'error' ? 'bg-red-600' : type === 'warn' ? 'bg-yellow-600' : 'bg-green-600'}`;
      t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), 3500);
    }

    function generateCode() {
      return Math.floor(10000 + Math.random() * 90000);
    }

    async function generateUniqueCode() {
      let code;
      let exists = true;
      while (exists) {
        code = generateCode();
        const { data } = await supabase.from('books').select('code').eq('code', code).single();
        exists = !!data;
      }
      return code;
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active', 'border-indigo-600', 'text-indigo-600', 'font-bold'));
      document.getElementById(tab).classList.remove('hidden');
      event.target.classList.add('active');
      loadAll();
    }

    // Rating Modal Helpers
    function setRating(rating) {
      selectedStars = rating;
      document.getElementById('selectedRating').textContent = rating;
      document.querySelectorAll('.star').forEach((star, index) => {
        star.classList.toggle('filled', index < rating);
      });
    }

    function closeRating() {
      document.getElementById('ratingModal').classList.add('hidden');
      selectedStars = 0;
      document.getElementById('reviewText').value = '';
      document.querySelectorAll('.star').forEach(star => star.classList.remove('filled'));
    }

    async function submitRating() {
      if (selectedStars === 0) return toast('Please select a rating', 'warn');
      const review = document.getElementById('reviewText').value.trim();

      const { error } = await supabase.from('ratings').insert({
        transaction_id: currentTransactionId,
        book_code: parseInt(document.getElementById('returnCode').value),
        roll_no: '', // Fetch from transaction; in production, pass from returnDetails
        rating: selectedStars,
        review
      });

      if (error) return toast(error.message, 'error');
      toast('Rating submitted! Thanks for feedback.');
      closeRating();
      loadBooks(); // Refresh averages
      loadHistory();
    }

    // ============ Books CRUD ============
    document.getElementById('bookForm').onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return toast('Login required', 'error');
      const title = document.getElementById('title').value.trim();
      const author = document.getElementById('author').value.trim();
      const category = document.getElementById('category').value.trim();
      const code = await generateUniqueCode();

      const { error } = await supabase.from('books').insert({
        code, title, author, category, status: 'Available', created_by: currentUser.id
      });
      if (error) return toast(error.message, 'error');
      toast(`Book Added: ${code}`);
      e.target.reset();
      loadBooks();
    };

    async function getAverageRating(code) {
      const { data } = await supabase.from('ratings').select('rating').eq('book_code', code);
      if (!data || data.length === 0) return { avg: 0, count: 0 };
      const avg = data.reduce((sum, r) => sum + r.rating, 0) / data.length;
      return { avg: Math.round(avg * 10) / 10, count: data.length };
    }

    async function loadBooks() {
      if (!currentUser) return;
      const container = document.getElementById('booksList');
      const search = document.getElementById('searchInput').value.toLowerCase();
      const sort = document.getElementById('sortSelect').value;

      let { data: books, error } = await supabase.from('books').select('*');
      if (error) return toast(error.message, 'error');

      // Fetch ratings for all books
      const bookCodes = books.map(b => b.code);
      const { data: allRatings } = await supabase.from('ratings').select('*').in('book_code', bookCodes);
      const ratingsMap = {};
      bookCodes.forEach(code => {
        const ratings = allRatings.filter(r => r.book_code === code);
        const avg = ratings.length ? (ratings.reduce((sum, r) => sum + r.rating, 0) / ratings.length).toFixed(1) : 'N/A';
        ratingsMap[code] = { avg, count: ratings.length };
      });

      if (search) {
        books = books.filter(b => 
          b.title.toLowerCase().includes(search) ||
          b.author.toLowerCase().includes(search) ||
          b.code.toString().includes(search)
        );
      }

      books.sort((a, b) => a[sort].localeCompare(b[sort]));

      container.innerHTML = books.map(async b => {
        const ratingInfo = ratingsMap[b.code];
        return `
          <div class="border-2 rounded-xl p-6 hover:shadow-xl transition bg-gradient-to-r from-${b.status === 'Available' ? 'green' : 'red'}-50">
            <h3 class="text-2xl font-bold">${b.title}</h3>
            <p class="text-lg"><strong>Author:</strong> ${b.author}</p>
            <p><strong>Category:</strong> ${b.category}</p>
            <p class="font-mono text-xl font-bold mt-3">Code: ${b.code}</p>
            <p class="text-2xl font-bold mt-3 ${b.status === 'Available' ? 'text-green-600' : 'text-red-600'}">${b.status}</p>
            <p class="text-lg mt-2"><strong>Rating:</strong> ${ratingInfo.avg}/5 (${ratingInfo.count} reviews)</p>
            <div class="mt-4 flex gap-3">
              <button onclick="editBook(${b.id})" class="bg-blue-600 text-white px-5 py-2 rounded-lg ${!currentUser ? 'hidden' : ''}">Edit</button>
              <button onclick="deleteBook(${b.id})" class="bg-red-600 text-white px-5 py-2 rounded-lg ${!currentUser ? 'hidden' : ''}">Delete</button>
            </div>
          </div>
        `;
      }).join(''); // Note: Await not needed in map; ratings fetched upfront
    }

    window.deleteBook = async (id) => {
      if (!currentUser) return toast('Login required', 'error');
      if (!confirm("Delete this book forever?")) return;
      const { error } = await supabase.from('books').delete().eq('id', id);
      if (error) return toast(error.message, 'error');
      toast('Book Deleted');
      loadBooks();
    };

    window.editBook = async (id) => {
      if (!currentUser) return toast('Login required', 'error');
      const { data: book } = await supabase.from('books').select('*').eq('id', id).single();
      const title = prompt("New Title", book.title);
      const author = prompt("New Author", book.author);
      if (title && author) {
        const { error } = await supabase.from('books').update({ title, author }).eq('id', id);
        if (error) return toast(error.message, 'error');
        toast('Book Updated');
        loadBooks();
      }
    };

    // Search & Sort Live
    document.getElementById('searchInput').oninput = loadBooks;
    document.getElementById('sortSelect').onchange = loadBooks;

    // ============ Issue Book (unchanged) ============
    document.getElementById('issueForm').onsubmit = async (e) => {
      e.preventDefault();
      if (!currentUser) return toast('Login required', 'error');
      const code = parseInt(document.getElementById('issueCode').value);
      const name = document.getElementById('studentName').value.trim();
      const roll = document.getElementById('rollNo').value.trim();

      const { data: book } = await supabase.from('books').select('*').eq('code', code).single();
      if (!book) return toast('Book not found!', 'error');
      if (book.status === 'Issued') return toast('Already Issued!', 'error');

      const issueDate = new Date();
      const dueDate = new Date();
      dueDate.setDate(dueDate.getDate() + 15);

      const trans = {
        book_code: code,
        book_title: book.title,
        student_name: name,
        roll_no: roll,
        issue_date: issueDate.toISOString(),
        due_date: dueDate.toISOString(),
        return_date: null,
        fine: 0,
        status: 'Issued',
        created_by: currentUser.id
      };

      const { error: bookError } = await supabase.from('books').update({ status: 'Issued' }).eq('code', code);
      const { data: transData, error: transError } = await supabase.from('transactions').insert(trans).select().single();
      if (bookError || transError) return toast('Error issuing book', 'error');
      toast(`Issued to ${name}! Due: ${dueDate.toLocaleDateString()}`);
      e.target.reset();
      loadIssued();
    };

    // ============ Return / Renew ============
    document.getElementById('returnCode').oninput = async function() {
      const code = parseInt(this.value);
      if (!code || code < 10000) { document.getElementById('returnDetails').innerHTML = ''; return; }

      const { data: trans } = await supabase.from('transactions').select('*').eq('book_code', code).eq('status', 'Issued').single();
      if (!trans) {
        document.getElementById('returnDetails').innerHTML = '<p class="text-red-600 text-2xl">Not issued or invalid code</p>';
        return;
      }

      const today = new Date();
      const due = new Date(trans.due_date);
      const lateDays = Math.max(0, Math.floor((today - due) / (1000*60*60*24)));
      const fine = lateDays * 2;
      currentBookTitle = trans.book_title; // For modal

      document.getElementById('returnDetails').innerHTML = `
        <div class="bg-gray-50 p-8 rounded-xl border-4 border-dashed mt-8">
          <h3 class="text-3xl font-bold">${trans.book_title}</h3>
          <p class="text-xl"><strong>Student:</strong> ${trans.student_name} (${trans.roll_no})</p>
          <p><strong>Due Date:</strong> ${due.toLocaleDateString()}</p>
          <p class="text-2xl font-bold text-red-600">Late by: ${lateDays} days → Fine: ₹${fine}</p>
          <div class="mt-8 flex gap-6">
            <button onclick="returnBook(${code}, ${fine}, ${trans.id})" class="bg-red-600 text-white px-10 py-5 rounded-xl text-xl font-bold hover:bg-red-700">
              Return Now (₹${fine} fine)
            </button>
            <button onclick="renewBook(${code})" class="bg-blue-600 text-white px-10 py-5 rounded-xl text-xl font-bold hover:bg-blue-700">
              Renew (+15 days)
            </button>
          </div>
        </div>
      `;
    };

    window.returnBook = async (code, fine, transId) => {
      if (!currentUser) return toast('Login required', 'error');
      const today = new Date();
      const { error: transError } = await supabase.from('transactions').update({
        return_date: today.toISOString(),
        fine,
        status: 'Returned'
      }).eq('id', transId);

      const { error: bookError } = await supabase.from('books').update({ status: 'Available' }).eq('code', code);

      if (transError || bookError) return toast('Error returning book', 'error');
      toast(`Book Returned! Fine Collected: ₹${fine}`);
      document.getElementById('returnCode').value = '';
      document.getElementById('returnDetails').innerHTML = '';
      currentTransactionId = transId; // For rating
      document.getElementById('bookTitleForRating').textContent = currentBookTitle;
      document.getElementById('ratingModal').classList.remove('hidden'); // Show rating modal
      loadIssued();
      loadHistory();
    };

    window.renewBook = async (code) => {
      if (!currentUser) return toast('Login required', 'error');
      const { data: trans } = await supabase.from('transactions').select('*').eq('book_code', code).eq('status', 'Issued').single();
      if (!trans) return;

      const newDue = new Date(trans.due_date);
      newDue.setDate(newDue.getDate() + 15);

      const { error } = await supabase.from('transactions').update({
        due_date: newDue.toISOString(),
        status: 'Renewed'
      }).eq('book_code', code).eq('status', 'Issued');

      if (error) return toast('Error renewing book', 'error');
      toast('Renewed! New Due: ' + newDue.toLocaleDateString());
      loadIssued();
    };

    // ============ Load Tables ============
    let issuedChannel, historyChannel;

    async function loadIssued() {
      if (!currentUser) return;
      const tbody = document.getElementById('issuedTable');
      let { data: transactions, error } = await supabase.from('transactions').select('*').or('status.eq.Issued,status.eq.Renewed');
      if (error) return toast(error.message, 'error');

      const today = new Date();
      transactions.forEach(t => {
        const due = new Date(t.due_date);
        const late = Math.max(0, Math.floor((today - due) / (86400000)));
        t.late = late;
        t.fine = late * 2;
      });

      tbody.innerHTML = transactions.map(t => `
        <tr class="${t.late > 0 ? 'bg-red-100' : ''}">
          <td class="px-6 py-4 font-mono">${t.book_code}</td>
          <td class="px-6 py-4 font-bold">${t.book_title}</td>
          <td class="px-6 py-4">${t.student_name}<br><small>${t.roll_no}</small></td>
          <td class="px-6 py-4">${new Date(t.issue_date).toLocaleDateString()}</td>
          <td class="px-6 py-4">${new Date(t.due_date).toLocaleDateString()}</td>
          <td class="px-6 py-4 font-bold text-red-600">${t.late}</td>
          <td class="px-6 py-4 font-bold text-red-600">₹${t.fine}</td>
        </tr>
      `).join('') || '<tr><td colspan="7" class="text-center py-10 text-gray-500">No books issued</td></tr>';

      if (issuedChannel) issuedChannel.unsubscribe();
      issuedChannel = supabase.channel('issued').on('postgres_changes', 
        { event: '*', schema: 'public', table: 'transactions' }, 
        () => loadIssued()
      ).subscribe();
    }

    async function loadHistory() {
      if (!currentUser) return;
      const tbody = document.getElementById('historyTable');
      let { data: history, error } = await supabase.from('transactions').select('*, ratings(rating, review)').eq('status', 'Returned');
      if (error) return toast(error.message, 'error');

      tbody.innerHTML = history.map(t => {
        const rating = t.ratings?.rating || 'N/A';
        const review = t.ratings?.review || '';
        return `<tr>
          <td class="px-6 py-4 font-mono">${t.book_code}</td>
          <td class="px-6 py-4">${t.student_name}<br><small>${t.roll_no}</small></td>
          <td class="px-6 py-4">${new Date(t.issue_date).toLocaleDateString()}</td>
          <td class="px-6 py-4">${t.return_date ? new Date(t.return_date).toLocaleDateString() : '-'}</td>
          <td class="px-6 py-4 font-bold">₹${t.fine}</td>
          <td class="px-6 py-4">${rating !== 'N/A' ? `${rating}/5 ${'★'.repeat(rating)}` : 'No rating'}</td>
          <td class="px-6 py-4"><span class="bg-green-200 px-4 py-2 rounded-full">Returned</span></td>
        </tr>`;
      }).join('') || '<tr><td colspan="7" class="text-center py-10 text-gray-500">No history yet</td></tr>';

      if (historyChannel) historyChannel.unsubscribe();
      historyChannel = supabase.channel('history').on('postgres_changes', 
        { event: '*', schema: 'public', table: 'transactions' }, 
        () => loadHistory()
      ).subscribe();
    }

    function loadAll() {
      if (!currentUser) return;
      if (document.getElementById('books').classList.contains('hidden') === false) loadBooks();
      if (document.getElementById('issued').classList.contains('hidden') === false) loadIssued();
      if (document.getElementById('history').classList.contains('hidden') === false) loadHistory();
    }

    // Cleanup
    window.addEventListener('beforeunload', () => {
      if (issuedChannel) issuedChannel.unsubscribe();
      if (historyChannel) historyChannel.unsubscribe();
    });
  </script>
</body>
</html>
